@{
    ViewBag.Title = "Pay";
}
@section styles {
    <link rel="stylesheet" href="~/Content/Css/Payment_List.css" />
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supership Checkout</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap">
</head>
<body>
    <!-- Checkout -->
    <main>
        <div class="left-section">

            <div class="breadcrumb">
                <a href="#">Giỏ hàng</a> &gt; <a href="#">Thông tin</a> &gt; <a href="#">Vận chuyển</a> &gt; <strong>Thanh toán</strong>
            </div>

            <h3>Liên hệ</h3>
            <div class="info" id="infoSection">
            </div>

            <h3>Thanh toán</h3>
            <p class="payment-note">Địa chỉ thanh toán của phương thức thanh toán phải khớp với địa chỉ giao hàng. Toàn bộ các giao dịch được bảo mật và mã hóa.</p>

            <div class="payment-method">
                <div class="payment-options">
                    <label class="payment-option one-pay-gateway">
                        <input type="radio" name="payment" value="onepay" checked>
                        <div class="payment-details">
                            <span class="payment-name">Cổng OnePAY - Thẻ ATM/QR/MoMo</span>
                            <div class="card-logos">
                                <img src="~/Content/Images/VISA.jfif" alt="VISA" />
                                <img src="~/Content/Images/mastercard.jpg" alt="MasterCard" />
                                <img src="~/Content/Images/JCB.jpg" alt="JCB" />
                                <img src="~/Content/Images/MoMo.jpg" alt="MoMo" />
                                <span>+2</span>

                            </div>

                        </div>
                        <div class="onepay-detail-text">Sau khi nhấp vào "Thanh toán ngay", bạn sẽ được chuyển hướng đến Cổng OnePAY - Thẻ ATM/QR/MoMo để hoàn tất việc mua hàng một cách an toàn.</div>
                    </label>

                    <label class="payment-option">
                        <input type="radio" name="payment" value="installment">
                        <span class="payment-name">Trả góp 0% lãi suất qua thẻ tín dụng</span>
                        <div class="card-logos-small">
                            <img src="~/Content/Images/VISA.jfif" alt="VISA" />
                            <img src="~/Content/Images/mastercard.jpg" alt="MasterCard" />
                            <img src="~/Content/Images/JCB.jpg" alt="JCB" />
                            <img src="~/Content/Images/AMEX.jpg" alt="Amex" />
                        </div>
                    </label>

                    <label class="payment-option">
                        <input type="radio" name="payment" value="zalopay">
                        <span class="payment-name">Ví ZaloPay</span>
                        <div class="card-logos-small">
                            <img src="~/Content/Images/Zalo.jpg" alt="ZaloPay" />
                            <img src="~/Content/Images/mastercard.jpg" alt="MasterCard" />
                            <img src="~/Content/Images/VISA.jfif" alt="VISA" />
                            <span>+2</span>
                        </div>
                    </label>

                    <label class="payment-option">
                        <input type="radio" name="payment" value="momo-onepay">
                        <span class="payment-name">Thanh toán MoMo qua OnePay</span>
                        <div class="card-logos-small">
                            <img src="~/Content/Images/MoMo.jpg" alt="MoMo" />
                            <img src="~/Content/Images/Onepay.jpg" alt="OnePay" />
                        </div>
                    </label>

                    <label class="payment-option">
                        <input type="radio" name="payment" value="cod">
                        <span class="payment-name">Thanh toán khi nhận hàng (COD)</span>
                    </label>
                </div>
            </div>

            <div class="terms-agreement">
                <input type="checkbox" id="terms" checked>
                <label for="terms">Tôi đồng ý với <a href="#">Điều khoản và Chính sách</a> quy định bởi Supersports*</label>
            </div>

            <div class="action-buttons">
                <a href="@Url.Action("DeliverLocate","Home")" class="back-link">&lt; Quay trở lại vận chuyển</a>
                <a href="#"><p id="confirmBtn" class="pay-button">Thanh toán ngay</p></a>
            </div>

            <div class="footer-links">
                <a href="#">Chính sách đổi trả</a> | <a href="#">Chính sách vận chuyển</a> | <a href="#">Chính sách quyền riêng tư</a> | <a href="#">Điều khoản dịch vụ</a>
            </div>

        </div>
        <div class="right-section">
            <h3>Đơn hàng</h3>
            <div class="product-list">
                <div class="product">

                </div>
            </div>

            <div class="coupon-section">
                <input type="text" placeholder="Nhập mã khuyến mãi" />
                <button>Áp dụng</button>
            </div>

            <div class="summary-line">
                <span>Tổng tiền hàng</span>
                <span class="amount">2.400.000 ₫</span>
            </div>
            <div class="summary-line">
                <span>Phí vận chuyển</span>
                <span class="amount free-ship">MIỄN PHÍ</span>
            </div>

            <div class="total-section">
                <span class="total-label">Tổng</span>
                <div class="total-amount-container">
                    <span class="vnd-label">VND</span>
                    <span class="total-final-amount">2.400.000 ₫</span>
                </div>
            </div>
        </div>
    </main>
    <!-- Thêm vào body, ngay trước </body> -->
    <div id="successPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
        <div style="background:#fff; padding:30px; border-radius:6px; max-width:400px; text-align:center; position:relative;">
            <h2 style="color:#002b5c; margin-bottom:15px;">✅ Thanh toán thành công!</h2>
            <p style="margin-bottom:25px;">Cảm ơn bạn đã đặt hàng. Bạn có thể tiếp tục mua sắm hoặc xem đơn hàng của mình.</p>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button id="goHomeBtn" style="padding:10px 20px; background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer;">Tiếp tục mua sắm</button>
                <button id="viewOrderBtn" style="padding:10px 20px; background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer;">Xem đơn hàng</button>
            </div>
            <span id="closePopup" style="position:absolute; top:10px; right:15px; cursor:pointer; font-weight:bold;">✕</span>
        </div>
    </div>
    <!-- Footer -->
    <!-- ==== JAVASCRIPT ==== -->
    <script>
        // Lấy thông tin đã lưu
        const info = JSON.parse(localStorage.getItem("shippingInfo"));
        const infoDiv = document.getElementById("infoSection");

        // --- LOGIC HIỂN THỊ THÔNG TIN GIAO HÀNG (GIỮ NGUYÊN) ---
        if (!info) {
            infoDiv.innerHTML = `
            <p style="color: red; font-weight: 500;">Không có thông tin giao hàng.</p>
            <p><a href='@Url.Action("DeliverLocate","Home")' class="change-link" style="color:#007bff;">Quay lại trang thông tin</a></p>
        `;
        } else {
            const contactEmail = info.email || 'N/A';
            const shippingAddressLine = info.address || 'N/A';
            const shippingCityDetail = info.city || 'N/A';
            const shippingMethod = info.shipping || 'Đang cập nhật';

            infoDiv.innerHTML = `
            <div class="info-row">
                <span class="info-label">Liên hệ</span>
                <span class="info-value">${contactEmail}</span>
                <a href="@Url.Action("DeliverLocate","Home")" class="change-link">Thay đổi</a>
            </div>
            <hr style="margin: 10px 0; border: none; border-top: 1px solid #eee;">
            <div class="info-row">
                <span class="info-label">Vận chuyển tới</span>
                <span class="info-value">${shippingAddressLine}, ${shippingCityDetail}</span>
                <a href="@Url.Action("DeliverLocate","Home")" class="change-link">Thay đổi</a>
            </div>
            <hr style="margin: 10px 0; border: none; border-top: 1px solid #eee;">
            <div class="info-row">
                <span class="info-label">Phương thức vận chuyển</span>
                <span class="info-value-shipping">${shippingMethod}</span>
                <span style="width: 50px;"></span>
            </div>
        `;
        }

        // Thêm style cho phần info (GIỮ NGUYÊN)
        const style = document.createElement('style');
        style.innerHTML = `
        .info-row { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; }
        .info-label { width: 150px; color: #666; }
        .info-value, .info-value-shipping { flex-grow: 1; text-align: left; font-weight: 500; }
        .info-value-shipping { font-weight: 600; color: #333; }
        .change-link { color: #007bff; text-decoration: none; font-size: 13px; width: 50px; text-align: right;}
`;
        document.head.appendChild(style);

        // --- LOGIC THANH TOÁN MỚI ---
        document.getElementById("confirmBtn").addEventListener("click", () => {
            const selectedPayment = document.querySelector('input[name="payment"]:checked');
            let paymentUrl = '';

            if (!selectedPayment) {
                alert("Vui lòng chọn phương thức thanh toán.");
                return;
            }

            switch (selectedPayment.value) {
                case 'onepay':
                    paymentUrl = '#';
                    break;
                case 'installment':
                    paymentUrl = '#';
                    break;
                case 'zalopay':
                    paymentUrl = '#';
                    break;
                case 'momo-onepay':
                    paymentUrl = '#';
                    break;
                case 'cod':
                    alert("✅ Đơn hàng đã được đặt thành công và sẽ thanh toán khi nhận hàng!");
                    paymentUrl = "#";
                    break;
                default:
                    alert("Phương thức thanh toán chưa được hoàn thiện.");
                    return;
            }

            if (selectedPayment.value !== 'cod') {
                window.location.href = paymentUrl;
            } else {
                window.location.href = paymentUrl;
            }

        });
        // --- HIỂN THỊ GIỎ HÀNG TRONG ĐƠN HÀNG ---
        function renderOrderCart() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            const container = document.querySelector(".right-section .product-list");
            let total = 0;

            if (!container) return;

            if (cart.length === 0) {
                container.innerHTML = `<p>Giỏ hàng trống</p>`;
                document.querySelectorAll(".summary-line .amount")[0].textContent = "0 ₫";
                document.querySelector(".total-final-amount").textContent = "0 ₫";
                return;
            }

            let html = "";
            cart.forEach(item => {
                const itemTotal = item.price * item.qty;
                total += itemTotal;

                html += `
            <div class="product">
                <div class="product-image-container">
                    <img src="${item.image}" alt="${item.name}">
                    <span class="quantity-badge">${item.qty}</span>
                </div>
                <div class="product-info">
                    <p class="product-name">${item.name}</p>
                    <p class="product-variant">${item.variant}</p>
                </div>
                <p class="product-price">${itemTotal.toLocaleString()} ₫</p>
            </div>
        `;
            });

            container.innerHTML = html;

            // Cập nhật tổng tiền
            document.querySelectorAll(".summary-line .amount")[0].textContent = total.toLocaleString() + " ₫";
            document.querySelector(".total-final-amount").textContent = total.toLocaleString() + " ₫";
        }

        // Khi trang load, render luôn giỏ hàng
        document.addEventListener("DOMContentLoaded", function () {
            renderOrderCart();
        });

document.getElementById("confirmBtn").addEventListener("click", () => {
    const selectedPayment = document.querySelector('input[name="payment"]:checked');
    const termsChecked = document.getElementById("terms").checked;

    if (!selectedPayment) {
        alert("Vui lòng chọn phương thức thanh toán.");
        return;
    }
    if (!termsChecked) {
        alert("Vui lòng đồng ý với Điều khoản và Chính sách trước khi thanh toán.");
        return;
    }

    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    if (cart.length === 0) {
        alert("Giỏ hàng trống!");
        return;
    }

    const shippingInfo = JSON.parse(localStorage.getItem("shippingInfo")) || {};
    const totalAmount = cart.reduce((sum, item) => sum + item.price * item.qty, 0);

    // Tạo đơn hàng mới
    const newOrder = {
        id: 'ORD' + Date.now(),
        date: new Date().toLocaleString(),
        items: cart,
        total: totalAmount,
        paymentMethod: selectedPayment.value,
        customerName: shippingInfo.fullName || "Chưa cập nhật",
        customerPhone: shippingInfo.phone || "Chưa cập nhật",
        customerAddress: shippingInfo.address || "Chưa cập nhật"
    };

    // Lưu vào lịch sử đơn hàng
    const ordersHistory = JSON.parse(localStorage.getItem("ordersHistory")) || [];
    ordersHistory.push(newOrder);
    localStorage.setItem("ordersHistory", JSON.stringify(ordersHistory));

    // Xóa giỏ hàng
    localStorage.removeItem("cart");

    // Hiển thị popup thành công
    const popup = document.getElementById("successPopup");
    popup.style.display = "flex";

    // Nút đóng popup
    document.getElementById("closePopup").onclick = () => {
        popup.style.display = "none";
    };

    // Nút tiếp tục mua sắm
    document.getElementById("goHomeBtn").onclick = () => {
        window.location.href = '@Url.Action("Category","Home")';
    };

    // Nút xem đơn hàng
    document.getElementById("viewOrderBtn").onclick = () => {
        window.location.href = '@Url.Action("OrderHistory", "Home")';
    };
});

    </script>


</body>
</html>
